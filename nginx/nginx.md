## Nginx

웹 애플리케이션 서버(WAS)의 트래픽 관리를 도와주는 비동기 이벤트 기반구조의 경량화 웹 서버 프로그램
클라이언트로부터 요청을 받았을 때 요청에 맞는 정적 파일을 응답해주는 HTTP Web Server로 활용되기도 하고,
Reverse Proxy Server로 활용하여 WAS 의 부하를 줄일 수 있는 로드밸런서 역할을 하기도 한다.

> document: https://docs.nginx.com/

### 만들어진 배경

#### Apache 구조
최초의 웹 서버는 1995년 UNIX 기반으로 만들어진 NCSA HTTPd 로 (CERN httpd 웹 서버가 먼저 출시됨) 이 프로그램은 버그가 굉장히 많아서 버그를 수정하여 만들어진 것이 바로 Apache Server 이다.
Apache 서버는 요청이 들어오면 커넥션(connection)을 생성, 이후 새로운 클라이언트의 요청이 올 때마다 새로운 프로세스(process)를 생성하는 방식으로 동작했고
프로세스를 생성하는 과정은 시간이 오래 걸리기 때문에 프로세스를 미리 만들어 놓는 PREFORK 라는 방식을 이용했다.
그래서 새로운 클라이언트의 요청이 들어오면 미리 만들어놓은 프로세스를 할당, 만약 만들어놓은 프로세스가 없다면 추가로 프로세스를 생성하도록 설계 되었다.
이런 구조 덕분에 개발자는 다양한 모듈을 만들어서 서버에 빠르게 기능을 추가할 수 있었고 확장성이 높고 동적 컨텐츠까지 처리할 수 있는 프로그램을 설계할 수 있었다.
하지만 1999년에 컴퓨터 보급에 보편화가 이뤄지고 이에 사용자 수가 증가하고 요청이 많아짐에 따라 서버에 동시에 연결된 커넥션이 많을 때
더 이상 새로운 커넥션을 생성하지 못하게 되었다. 이는 C10K(connection 10000 problem)문제라 정의됐고 기존 방식이 문제가 되었다.

- Apache Server 문제점
  1. 메모리 부족: 커넥션 이 연결될 때마다 프로세스를 생성
  2. 무거운 프로그램: 확장성이 좋다 == 리소스가 많다
  3. CPU 부하 증가: 대량의 connection 요청이 들어오면 context switching 이뤄짐에 따라 CPU 부하가 증가

즉, Apache Server 는 현대로 올수록 사용하기 꺼려졌고, 이러한 구조적 문제점을 해결할 목적으로 초기 Nginx 가 2004년에 출시되었다.
초기 Nginx 는 Apache와 함께 사용하기 위해 만들어졌고 웹 서버이지만 아파치 서버를 완전히 대체할 목적은 아니었다.
커넥션을 nginx 가 유지하고, nginx 도 웹 서버이기에 정적 파일에 대한 요청은 스스로 처리하고,
클라이언트로부터 동적 파일의 요청을 받았을 때만 아파치 서버와 커넥션을 형성하여 아파치 서버의 부하를 줄였다.

#### Nginx 내부 흐름
설정 파일을 읽고 -> 워커 프로세스(worker process) 생성(마스터 프로세스(master process)
 
- 워커 프로세스는 생성될때 listen 소켓을 배정 받는다.
  - 해당 소켓으로 사용자 요청이 들어오면 커넥션을 생성하고 처리한다.
    이때 커넥션은 정해진 시간 (Keep-Alive) 만큼 유지 된다.
    생성된 커넥션으로부터 아무런 요청이 없다면 새로운 커넥션을 형성하거나 이미 만들어진 다른 커넥션으로부터 들어온 요청을 처리한다.

#### Nginx 이벤트(event)
- 커넥션 형성과 제거, 그리고 새로운 요청을 처리하는 것을 이벤트(event)라 한다.
- 이벤트들은 OS 커널이 queue 형식으로 워커 프로세스에게 전달한다.
- 이벤트들은 queue에 담긴 상태에서 비동기 상태로 대기 -> 워커 프로세스가 하나의 스레드로 이벤트를 꺼내서 처리해 나간다.
  이런 방식은 워커가 쉬지 않고 일을 하기에, 아파치 서버보다 훨씬 효율적으로 자원을 사용할 수 있습니다.

#### 방식 비교
 - Apache: 스레드 방식
 - Nginx: Event-driven 방식

#### Nginx 장점
- 이벤트 중심 접근 방식을 사용하여 클라이언트 요청 제공
- 제한된 하드웨어 리소스로도 여러 클라이언트 요청을 동시에 효율적으로 처리
- 단일 스레드를 통해 여러 연결을 처리 가능
- 최소한의 리소스로 웹 서버의 아키텍처를 개선하기 위해 독립형 HTTP 서버로 배치 가능

#### Nginx 단점
 - 동적 컨텐츠를 기본적으로 처리 할 수 없음
   - 동적 컨텐츠 처리를 위해서는 처리를 외부 프로세스에 전달하고 랜더링된 컨텐츠를 다시 전송한다.
 - 동적 컨텐츠를 위한 외부 프로세스와 연계로 인한 프로세스 속도 저하
